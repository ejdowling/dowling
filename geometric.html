<html>
<title>G</title>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
<canvas>bobby</canvas>
<div id="sliders">
    <input id="a" type="range" min="3" max="20" value="5">
    <input id="b" type="range" min="0" max="8" value="7">
    <input type="checkbox" id="c" checked="checked">
    <button id="copy">copy link</button>
</div>
<script>
const hash = (s) => {
    let h;
    for (let i = 0; i < s.length; i++) {
        h = Math.imul(31, h) + s.charCodeAt(i) | 0;
    }
    return h;
};

const init = () =>{
    const dpp = window.devicePixelRatio || 1;
    const canvas = document.querySelector("canvas");
    const width = window.innerWidth * dpp;
    const height = window.innerHeight * dpp;
    canvas.width = window.innerWidth * dpp;
    canvas.height = window.innerHeight * dpp;
    const ctx = canvas.getContext('2d');
    const slidera = document.querySelector("input#a");
    const sliderb = document.querySelector("input#b");
    const checkbox = document.querySelector("input#c");
    const copy_button = document.querySelector("button#copy");
    ctx.font = "30px Arial";
    ctx.lineJoin = "round";

    const colours = [
        "#747369",
        "#d3d0c8",
        "#f2777a",
        "#f99157",
        "#ffcc66",
        "#99cc99",
        "#66cccc",
        "#4f7cac",
        "#cc99cc",
    ];

    const points = [
        [ 0.000000,  0.000000 ],
        [ 0.600000,  0.346800 ],
        [ 0.600000, -0.353200 ],
        [ 0.700000,  0.000000 ],
        [ 1.000000, -0.577400 ],
        [ 1.000000,  0.000000 ],
        [ 1.000000,  0.577400 ],
        [ 1.300000,  0.000000 ],
        [ 1.400000, -0.350000 ],
        [ 1.400000,  0.346000 ],
        [ 1.500000, -0.866000 ],
        [ 1.500000,  0.866000 ],
        [ 1.647800, -0.610200 ],
        [ 1.654600,  0.598200 ],
        [ 1.726400,  0.996800 ],
        [ 1.737600, -1.003200 ],
        [ 1.876600,  0.680000 ],
        [ 1.879800, -0.696600 ],
        [ 2.000000,  0.000000 ],
        [ 2.347600,  0.602200 ],
        [ 2.354600, -0.614200 ],
        [ 2.600000,  0.350000 ],
        [ 2.600000, -0.354000 ],
        [ 2.704600,  0.000000 ],
        [ 3.000000, -0.577400 ],
        [ 3.000000, -1.732000 ],
        [ 3.000000,  0.000000 ],
        [ 3.000000,  0.577400 ],
        [ 3.000000,  1.732000 ],
    ];

    const parameters = window.location.search.split(",");
    const seed = parameters[0].substring(1);
    slidera.value = Number(parameters[1]) || 5;
    sliderb.value = Number(parameters[2]) || 7;
    checkbox.checked = Boolean(Number(parameters[3]));

    let raw_seed = new Uint32Array(1);
    if (!seed) {
        window.crypto.getRandomValues(raw_seed);
    } else {
        try {
            raw_seed = Uint32Array.from(window.atob(seed).split(','));
        } catch {
            window.crypto.getRandomValues(raw_seed);
        }
    }

    const rand = ((a, b, c, d) => {
        return () => {
            let t = b << 9, r = a * 5;
            r = (r << 7 | r >>> 25) * 9;
            c ^= a;
            d ^= b;
            b ^= c;
            a ^= d;
            c ^= t;
            d = d << 11 | d >>> 21;
            return (r >>> 0) / 4294967296;
        }
    })(raw_seed[0], raw_seed[1], raw_seed[2], raw_seed[3]);

    let walk = [];
    let scale = Math.sqrt((canvas.width*canvas.width)+(canvas.height*canvas.height)) / 80;

    const generate = (dont_reseed) => {
        if (!dont_reseed) window.crypto.getRandomValues(raw_seed);
        walk = [];
        let lines = slidera.value;
        for (let i = 0; i < lines; ++i) {
            const n = Math.floor(rand() * points.length);
            if (!walk.includes(n)) walk.push(n);
        }
    };

    const render = () => {
        var checkBox = document.getElementById("c");
        ctx.setTransform();
        ctx.scale(scale, scale);
        ctx.fillStyle = "#121212";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = colours[sliderb.value];
        ctx.lineWidth = 0.12;
        for (let ty = Math.floor(-canvas.height/600); ty < Math.floor(canvas.height/100); ++ty) {
            const rx = 3 * Math.sin(1.04719);
            const ry = ty * 12 * Math.sin(1.04719);
            for (let tx = Math.floor(-canvas.width/200); tx < Math.floor(canvas.width/50); ++tx) {
                const xoff = rx + tx * 3;
                const yoff = ry + (tx & 1) * (6 * Math.sin(1.04719));
                const x = xoff + Math.cos(1.04719);
                const y = yoff + Math.sin(1.04719);
                ctx.save();
                ctx.translate(x,y);
                for (let a = 0; a < 6; a++) {
                    ctx.beginPath();
                    ctx.translate(width/100, height/100);
                    ctx.moveTo(points[walk[0]][0],points[walk[1]][1]);
                    for (let i = 1; i < walk.length; ++i){
                        ctx.lineTo(points[walk[i]][0],points[walk[i]][1]);
                    }
                    if (checkBox.checked) {
                        ctx.fillStyle = colours[sliderb.value];
                    } else {
                        ctx.fillStyle = "#121212";
                    }
                    ctx.fill();
                    ctx.closePath();
                    ctx.stroke();
                    ctx.rotate(1.0479);
                    ctx.translate(-width/100, -height/100);
                }
                ctx.restore();
            }
        }
    };

    slidera.addEventListener('input', () => { generate(); render(); });
    sliderb.addEventListener('input', render);
    checkbox.addEventListener('input', render)
    copy_button.addEventListener('click', () => {
        const new_url = new URL(window.location);
        const search = `${window.btoa(raw_seed).replaceAll("=","")},${slidera.value},${sliderb.value},${checkbox.checked&1}`;
        new_url.search = search;
        navigator.clipboard.writeText(new_url);
    });
    window.addEventListener('keydown', (e) => {
        if (e.keyCode != 32) return;
        event.preventDefault();
        generate();
        render();
    });
    canvas.addEventListener('dblclick', () => { generate(); render(); });

    generate(true);
    render();

    ctx.save();
    ctx.setTransform();
    const text = "Press SPACE or double tap screen for a new pattern.";
    const metrics = ctx.measureText(text);
    ctx.fillStyle = "#222222aa";
    const padding = 40;
    const w = metrics.width + padding*2;
    ctx.fillRect(
        width/2 - (metrics.actualBoundingBoxLeft + padding) - w/2,
        ((3*height)/4) - (metrics.actualBoundingBoxAscent + padding),
        metrics.width + padding*2,
        30 - metrics.actualBoundingBoxDescent + padding*2
    );
    ctx.fillStyle = "white";
    ctx.fillText(text, width/2 - w/2, (3*height)/4);
    ctx.restore();

    setTimeout(render, 5000);
};

window.addEventListener('load', init);
</script>
</body>
</html>
